<!doctype html>

<script type="text/javascript" src="md5.js"></script>
<link rel="stylesheet" href="bootstrap-3.4.1.min.css">
<script type="text/javascript" src="jquery-3.5.1.js"></script>
<script src="bootstrap-3.4.1.min.js"></script>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>No Phone Contact Tracer (NPCT)</title>

</head>

<body>

<div class="container">
  <div class="row">


    <h3>Welcome!</h3>
     

      Welcome to the No Phone Contact Tracer (NPCT) Project
      <ul>
        <li> This tracer is completely anonymous and doesn't involve your phone at all.
        <li> If you wish, please turn off your Wifi now, or unplug your computer's Internet cable. 
        <li> This page will help you to get started participating in contact tracing.
        <li> This page runs only on your own computer, and does not contact any external webserver.
      </ul>

       <div id="content"></div>

       <h3>As you go out and about today, click on any symptoms you have<small> (<a href="https://www.who.int/publications/i/item/contact-tracing-in-the-context-of-covid-19">Ref.</a>)</small></h3>
      
      <div class="form-group">

        
          <input type="checkbox" value="1"> I am feeling fine.
          <br/>

          <input type="checkbox" value="2"> Sore throat
          <br/>    
        
       
          <input type="checkbox" value="4"> Cough
          <br/>  

       
          <input type="checkbox" value="8"> Runny nose or nasal congestion
          <br/>

        
          <input type="checkbox" value="16"> Shortness of breath or difficulty breathing
          <br/>

      
          <input type="checkbox" value="32"> Muscle pain
          <br/>

       
          <input type="checkbox" value="64"> Loss of smell or taste
          <br/>

        
          <input type="checkbox" value="128"> Diarrhea
          <br/>


       
          <input type="checkbox" value="256"> I tested negative for Covid-19
          <br/>

         
          <input type="checkbox" value="512"> I tested positive for Covid-19
          <br/>

          <input type="checkbox" value="1024"> I was wearing a mask
          <br/>

          <input type="checkbox" value="2048"> I was not wearing a mask
          <br/>

    </div>


       

      <p/>
      <button class="btn btn-info" onclick="bt_update()">Update hardware</button>
      <hr/>
      <h3>Contact Tracer Log</h3>
      <button onclick="bt_read()" class="btn btn-primary btn-xs">Read Device Log</button>
      <br/>
      <br/>
      <textarea id="device_dump" class="form-control" rows=10></textarea>

  </div>
</div>

</body>
</html>


<script>

  var mouseX = 0, mouseY = 0;
  const PACKET_SIZE = 20;
  const hash_salt = "b063f85e5dbc0310dfc860e012965552";

$( ".container" ).mousemove(function( event ) {
  mouseX += event.pageX;
  mouseY += event.pageY;
});

//localStorage.clear();
var private_id; 
var public_id = localStorage.getItem('public_id');

if (public_id == null)
{
  //https://stackoverflow.com/questions/8532406/create-a-random-token-in-javascript-based-on-user-details
  private_id = md5(navigator.userAgent + new Date().getTime() + mouseX.toString() + mouseY.toString() + window.outerHeight.toString() + window.outerWidth.toString());
  public_id = md5(hash_salt + private_id).substring(0,16);
  localStorage.setItem('public_id',public_id);
  $('#content').html(`
    <h3>Initial configuration</h3>
   Looks like you're setting up the contact tracing hardware for the first time.
   <br/>
   <br/>
   <textarea rows=3 class="form-control" readonly>
   Your public contact tracing ID will be: ` + public_id + `
   Your private verification code will be: ` + private_id + `
   </textarea>
   <br/>
   Please copy these into a safe place (like a Word document on your computer for safekeeping). It is important that you
   always use these IDs throughout your participation in contact tracing. For you to remain unique in this effort, please 
   never change this ID, or request a new one.
   <br/>
   <br/>
                    `);

}

function decode_health(num)
{
  var codes = {
      1: "Feeling fine",
      2: "Sore throat", 
      4: "Cough", 
      8: "Runny nose or nasal congestion", 
      16: "Shortness of breath or difficulty breathing", 
      32: "Muscle pain" ,
      64: "Loss of smell or taste",
      128: "Diarrhea",
      256: "Tested negative for Covid-19",
      512: "Tested positive for Covid-19",
      1024: "Wearing a mask",
      2048: "Not wearing a mask"
    };
  var ret = "";

  Object.keys(codes).forEach(function(key) 
                              {
                                if (num & key)
                                  ret = ret + codes[key] + ", ";
                              });
  return(ret);
}

function decode(str)
{
  var id, health, count;

  if (str.length != 20)
    return(str);

  id = str.substring(0,16);
  health = parseInt(str.substring(16,18),16);
  count = parseInt(str.substring(18,20),16);

  return("Person: " + id + " was encountered " + count.toString() + " times. Health condition: " + health.toString());
}

function test_health()
{
  var health = 0;
  
  $('input[type=checkbox]').each(function () {
     if (this.checked) {
        health += parseInt($(this).val()); 
     }
  });

  console.log(health,decode_health(health));

}

async function bt_read()
{
    var device;
    var read_int;

    try
    {
      device = await navigator.bluetooth.requestDevice(
        {
          filters: [
            {namePrefix: '#C19:'},
            {services: ['0000feed-0000-1000-8000-00805f9b34fb']},
          ],
        });

      const server = await device.gatt.connect();
     

      $('#device_dump').val("");   
      read_encounters();

      async function read_encounters()
            {
              const service = await server.getPrimaryService('0000feed-0000-1000-8000-00805f9b34fb');
              const characteristic = await service.getCharacteristic('0000c0de-0000-1000-8000-00805f9b34fb');
              const value = await characteristic.readValue();
              var data = new TextDecoder("utf-8").decode(value);
              var i, dump;

              if (data.substring(0,3) == 'end')
              {
                clearInterval(read_int);
                device.gatt.disconnect();
              }
              else
              {
                dump = "";
                for(i=0;i<data.length;i += PACKET_SIZE)
                  dump = dump + decode(data.substring(i,i + PACKET_SIZE)) + "\n";
                $('#device_dump').val($('#device_dump').val() + dump);              
                read_int = setTimeout(read_encounters,500);
              }
            }
       }
       catch(error)
        {
          console.log(error);
        }


  }



function bt_update()
{
    var bt_device;
    var health = 0, health_hex;
    var update_id;
    var i;
    var a = []

    $('input[type=checkbox]').each(function () {
           if (this.checked) {
              health += parseInt($(this).val()); 
           }
      });

    health_hex = health.toString(16).padStart(2,"0");
    update_id = public_id + health_hex;

    console.log(update_id);

    navigator.bluetooth.requestDevice({
      filters: [
        //{namePrefix: '#C19:'}
         {services: ['0000feed-0000-1000-8000-00805f9b34fb']},
      ],
      })
        .then(device => 
                    { 
                      bt_device = device;
                      return device.gatt.connect();
                    })
        .then(server => {
          return server.getPrimaryService('0000feed-0000-1000-8000-00805f9b34fb');
        })
        .then(service => {
          return service.getCharacteristic('0000c0de-0000-1000-8000-00805f9b34fb');
        })
        .then(characteristic => {
          for (var i = 0; i < update_id.length; i ++)
            a.push(update_id.charCodeAt(i));
          return characteristic.writeValue(new Uint8Array(a));
        })
        .then(_ => 
        {
          alert("Device updated. Please remove, then restore power to complete update.")
          bt_device.gatt.disconnect();
        })
        .catch(error => 
          { 
            console.log(error); 
          });

}
</script>

</body>
</html>